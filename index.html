<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhavishya Enterprise - Online Crane Management</title>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- PDF helpers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root{--primary:#2c3e50;--secondary:#3498db;--accent:#e74c3c;--light:#ecf0f1}
        body{font-family:Inter,Segoe UI,Helvetica,Arial;min-height:100vh;background:#f4f6f9}
        .sidebar{background:var(--primary);color:#fff;min-height:100vh}
        .nav-link{color:rgba(255,255,255,0.9)}
        .nav-link.active{background:rgba(255,255,255,0.06)}
        .card{border-radius:10px}
        .hidden{display:none}
        .user-badge{background:var(--secondary);color:#fff;padding:4px 10px;border-radius:20px}
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card p-4 shadow-sm">
                <h4 class="mb-3"><i class="fas fa-cogs"></i> Bhavishya Enterprise</h4>
                <p class="text-muted">Sign in to manage cranes, worksheets and invoices</p>

                <form id="signInForm">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input id="signInEmail" class="form-control" type="email" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input id="signInPassword" class="form-control" type="password" required />
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" type="submit">Sign In</button>
                        <button id="showRegisterBtn" class="btn btn-outline-secondary" type="button">Create account</button>
                    </div>
                </form>

                <hr />
                <small class="text-muted">If you have a local-only user list, sign up once using any email and the admin will convert accounts online.</small>
            </div>
        </div>
    </div>
</div>

<!-- APP SCREEN -->
<div id="appScreen" class="hidden">
    <nav class="navbar navbar-expand-lg" style="background:var(--primary);">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#"><i class="fas fa-cogs"></i> Bhavishya Enterprise</a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3"><i class="fas fa-user"></i> <span id="displayName">User</span> <span id="displayRole" class="user-badge ms-2">Role</span></span>
                <button id="btnLogout" class="btn btn-light btn-sm">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <aside class="col-md-3 sidebar p-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" href="#" data-tab="dashboard"> <i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="clients"> <i class="fas fa-users"></i> Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="worksheets"> <i class="fas fa-clipboard-list"></i> Worksheets</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="invoices"> <i class="fas fa-file-invoice-dollar"></i> Invoices</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" href="#" data-tab="cranes"> <i class="fas fa-truck-monster"></i> Cranes</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" href="#" data-tab="users"> <i class="fas fa-user-shield"></i> Users</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="company"> <i class="fas fa-building"></i> Company</a></li>
                </ul>
            </aside>

            <main class="col-md-9 p-4">
                <!-- DASHBOARD -->
                <section id="dashboard" class="tab-content">
                    <div class="row mb-3">
                        <div class="col-md-3"><div class="card p-3"><h6>Total Clients</h6><h3 id="totalClients">0</h3></div></div>
                        <div class="col-md-3"><div class="card p-3"><h6>Worksheets</h6><h3 id="totalWorksheets">0</h3></div></div>
                        <div class="col-md-3"><div class="card p-3"><h6>Invoices</h6><h3 id="totalInvoices">0</h3></div></div>
                        <div class="col-md-3"><div class="card p-3"><h6>Revenue</h6><h3 id="totalRevenue">₹0</h3></div></div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">Recent Worksheets</div>
                                <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0"><thead><tr><th>Date</th><th>Client</th><th>Crane</th><th>Hours</th><th>Amount</th></tr></thead><tbody id="recentWorksheets"></tbody></table></div></div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Recent Invoices</div>
                                <div class="card-body" id="recentInvoices"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CLIENTS -->
                <section id="clients" class="tab-content hidden">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Clients</h5>
                            <div>
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">Add Client</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive"><table class="table"><thead><tr><th>Name</th><th>Mobile</th><th>GST</th><th>State</th><th>Actions</th></tr></thead><tbody id="clientsTable"></tbody></table></div>
                        </div>
                    </div>
                </section>

                <!-- WORKSHEETS -->
                <section id="worksheets" class="tab-content hidden">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <h5>Worksheets</h5>
                            <div>
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#worksheetModal">New Worksheet</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Client</th><th>Crane</th><th>In</th><th>Out</th><th>Lunch</th><th>Total</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="worksheetsTable"></tbody></table></div>
                        </div>
                    </div>
                </section>

                <!-- INVOICES -->
                <section id="invoices" class="tab-content hidden">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">Create Invoice</div>
                                <div class="card-body">
                                    <form id="invoiceForm">
                                        <div class="row mb-2">
                                            <div class="col-md-6"><label>Client</label><select id="invoiceClient" class="form-select" required><option value="">Select client</option></select></div>
                                            <div class="col-md-6"><label>Invoice No</label><input readonly id="invoiceNo" class="form-control" value="INV-" /></div>
                                        </div>

                                        <div class="table-responsive mb-2"><table class="table"><thead><tr><th></th><th>Date</th><th>Hours</th><th>Rate</th><th>Amount</th><th></th></tr></thead><tbody id="invoiceItems"></tbody><tfoot><tr><td colspan="4" class="text-end">Subtotal</td><td id="invSubtotal">₹0</td><td></td></tr><tr><td colspan="4" class="text-end">GST (18%)</td><td id="invGST">₹0</td><td></td></tr><tr><td colspan="4" class="text-end"><strong>Total</strong></td><td id="invTotal"><strong>₹0</strong></td><td></td></tr></tfoot></table></div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-outline-secondary" type="button" id="importClientWorksheets">Import Client Worksheets</button>
                                            <button class="btn btn-primary" type="submit">Generate Invoice</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Invoice History</div>
                                <div class="card-body" id="invoicesHistory"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CRANES -->
                <section id="cranes" class="tab-content hidden admin-only">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between"><h5>Cranes</h5><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#craneModal">Add Crane/User</button></div>
                        <div class="card-body"><div class="table-responsive"><table class="table"><thead><tr><th>Crane No</th><th>Assigned To</th><th>Actions</th></tr></thead><tbody id="cranesTable"></tbody></table></div></div>
                    </div>
                </section>

                <!-- USERS -->
                <section id="users" class="tab-content hidden admin-only">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between"><h5>Users</h5><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">Add User</button></div>
                        <div class="card-body"><div class="table-responsive"><table class="table"><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead><tbody id="usersTable"></tbody></table></div></div>
                    </div>
                </section>

                <!-- COMPANY -->
                <section id="company" class="tab-content hidden">
                    <div class="card"><div class="card-body"><h5>Bhavishya Enterprise</h5><p>Crane Service - details...</p></div></div>
                </section>

            </main>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5>Add / Edit Client</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="clientFormOnline"><div class="row"><div class="col-md-6"><div class="mb-3"><label>Name</label><input id="c_name" class="form-control" required></div><div class="mb-3"><label>Mobile</label><input id="c_mobile" class="form-control"></div></div><div class="col-md-6"><div class="mb-3"><label>GST</label><input id="c_gst" class="form-control"></div><div class="mb-3"><label>State</label><input id="c_state" class="form-control"></div></div></div></form></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="saveClientBtn" class="btn btn-primary">Save</button></div></div></div></div>

<!-- Worksheet Modal -->
<div class="modal fade" id="worksheetModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5>Create Worksheet</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="worksheetFormOnline"><div class="row"><div class="col-md-6"><div class="mb-3"><label>Client</label><select id="ws_client" class="form-select"></select></div><div class="mb-3"><label>Crane</label><select id="ws_crane" class="form-select"></select></div></div><div class="col-md-6"><div class="mb-3"><label>Date</label><input id="ws_date" class="form-control" type="date"></div><div class="mb-3"><label>In Time</label><input id="ws_in" class="form-control" type="time"></div><div class="mb-3"><label>Out Time</label><input id="ws_out" class="form-control" type="time"></div><div class="mb-3"><label>Lunch Minutes</label><input id="ws_lunch" class="form-control" type="number" value="30"></div><div class="mb-3"><label>Total Hours</label><input id="ws_total" class="form-control" readonly></div></div></div><div class="mb-3"><label>Work Details</label><textarea id="ws_details" class="form-control"></textarea></div><div class="row"><div class="col-md-6"><label>Rate (₹ per hour)</label><input id="ws_rate" class="form-control" type="number" value="1500"></div><div class="col-md-6"><label>Amount (₹)</label><input id="ws_amount" class="form-control" readonly></div></div></form></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="saveWorksheetBtn" class="btn btn-primary">Save Worksheet</button></div></div></div></div>

<!-- User/Crane Modal (Admin creates auth users) -->
<div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Add User / Crane (Admin)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="userFormOnline"><div class="mb-3"><label>Email</label><input id="u_email" class="form-control" type="email" required></div><div class="mb-3"><label>Full Name</label><input id="u_name" class="form-control"></div><div class="mb-3"><label>Role</label><select id="u_role" class="form-select"><option value="operator">Operator</option><option value="admin">Admin</option></select></div><div class="mb-3"><label>Temp Password</label><input id="u_pass" class="form-control" type="password" required></div><div class="mb-3"><label>Admin password (required to restore admin session after creating user)</label><input id="admin_reauth_pass" class="form-control" type="password"></div></form></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="saveUserBtn" class="btn btn-primary">Create User</button></div></div></div></div>

<!-- Crane Modal (simple extra details) -->
<div class="modal fade" id="craneModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Add Crane</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="craneFormOnline"><div class="mb-3"><label>Crane No</label><input id="crane_no" class="form-control"></div><div class="mb-3"><label>Assigned User Email (optional)</label><input id="crane_user_email" class="form-control"></div></form></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button id="saveCraneBtn" class="btn btn-primary">Save Crane</button></div></div></div></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ----------------- Firebase config (kept as requested) -----------------
const firebaseConfig = {
  apiKey: "AIzaSyCAXNe8AMw6tyFSHUGP13357elIkPuCoFM",
  authDomain: "bhavishya-enterprise.firebaseapp.com",
  projectId: "bhavishya-enterprise",
  storageBucket: "bhavishya-enterprise.firebasestorage.app",
  messagingSenderId: "68829794521",
  appId: "1:68829794521:web:2933f17847e5d043666ec8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// UI elements
const authScreen = document.getElementById('authScreen');
const appScreen = document.getElementById('appScreen');
const displayName = document.getElementById('displayName');
const displayRole = document.getElementById('displayRole');

let currentUser = null; // firestore user doc

// Auth state
auth.onAuthStateChanged(async user => {
  if (!user) { showAuth(); return; }
  // load user doc
  try {
    const udoc = await db.collection('users').doc(user.uid).get();
    if (!udoc.exists) {
      // If user signs up directly, create a basic user doc
      const newDoc = { name: user.email, email: user.email, role: 'operator', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      await db.collection('users').doc(user.uid).set(newDoc);
      currentUser = { uid: user.uid, ...newDoc };
    } else {
      currentUser = { uid: user.uid, ...(udoc.data()) };
    }

    showApp();
    attachSnapshots();
  } catch (e) { console.error(e); showAuth(); }
});

function showAuth(){ authScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); }
function showApp(){ authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); displayName.textContent = currentUser.name || currentUser.email; displayRole.textContent = currentUser.role || 'operator';
  // show admin-only
  document.querySelectorAll('.admin-only').forEach(el => { el.style.display = currentUser.role === 'admin' ? '' : 'none'; });
}

// Sign-in / Register
document.getElementById('signInForm').addEventListener('submit', async (e)=>{ e.preventDefault();
  const email = document.getElementById('signInEmail').value; const pass = document.getElementById('signInPassword').value;
  try { await auth.signInWithEmailAndPassword(email, pass); } catch(err){ alert('Sign in failed: '+err.message); }
});

// Logout
document.getElementById('btnLogout').addEventListener('click', ()=>auth.signOut());

// Tab navigation
document.querySelectorAll('[data-tab]').forEach(el=> el.addEventListener('click', (ev)=>{
  ev.preventDefault(); const tab = el.getAttribute('data-tab'); showTab(tab);
  document.querySelectorAll('[data-tab]').forEach(x=>x.classList.remove('active')); el.classList.add('active');
}));
function showTab(name){ document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden')); document.getElementById(name).classList.remove('hidden'); }

// ---------------- Firestore snapshots for live UI ----------------
let unsubClients=null, unsubWorksheets=null, unsubInvoices=null, unsubUsers=null, unsubCranes=null;
function attachSnapshots(){
  if (unsubClients) unsubClients(); if (unsubWorksheets) unsubWorksheets(); if (unsubInvoices) unsubInvoices(); if (unsubUsers) unsubUsers(); if (unsubCranes) unsubCranes();

  unsubClients = db.collection('clients').orderBy('createdAt','desc').onSnapshot(snap=>{
    const clients = []; snap.forEach(d=>clients.push({id:d.id,...d.data()})); renderClients(clients);
  });

  unsubWorksheets = db.collection('worksheets').orderBy('date','desc').onSnapshot(snap=>{
    const sheets = []; snap.forEach(d=>sheets.push({id:d.id,...d.data()})); renderWorksheets(sheets);
  });

  unsubInvoices = db.collection('invoices').orderBy('date','desc').onSnapshot(snap=>{
    const invs = []; snap.forEach(d=>invs.push({id:d.id,...d.data()})); renderInvoices(invs);
  });

  unsubUsers = db.collection('users').orderBy('createdAt','desc').onSnapshot(snap=>{
    const us = []; snap.forEach(d=>us.push({id:d.id,...d.data()})); renderUsers(us);
  });

  unsubCranes = db.collection('cranes').orderBy('createdAt','desc').onSnapshot(snap=>{
    const cs = []; snap.forEach(d=>cs.push({id:d.id,...d.data()})); renderCranes(cs);
  });
}

// ---------------- Rendering helpers ----------------
function renderClients(clients){
  const tbody = document.getElementById('clientsTable'); const invoiceClient = document.getElementById('invoiceClient'); const ws_client = document.getElementById('ws_client');
  tbody.innerHTML = clients.map(c=>`<tr><td>${c.name}</td><td>${c.mobile||''}</td><td>${c.gst||'N/A'}</td><td>${c.state||''}</td><td><button class=\"btn btn-sm btn-primary\" onclick=\"editClient('${c.id}')\">Edit</button> <button class=\"btn btn-sm btn-danger\" onclick=\"deleteClient('${c.id}')\">Delete</button></td></tr>`).join('')||'<tr><td colspan="5">No clients</td></tr>';
  invoiceClient.innerHTML = '<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  ws_client.innerHTML = '<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('totalClients').textContent = clients.length;
}

function renderWorksheets(sheets){
  const tbody = document.getElementById('worksheetsTable'); const recent = document.getElementById('recentWorksheets');
  tbody.innerHTML = sheets.map(s=>`<tr><td>${new Date(s.date).toLocaleDateString()}</td><td>${s.clientName}</td><td>${s.craneNo}</td><td>${s.inTime}</td><td>${s.outTime}</td><td>${s.lunchMinutes}</td><td>${s.totalHours}</td><td>₹${s.amount}</td><td><button class=\"btn btn-sm btn-danger\" onclick=\"deleteWorksheet('${s.id}')\">Del</button></td></tr>`).join('')||'<tr><td colspan="9">No worksheets</td></tr>';
  recent.innerHTML = sheets.slice(0,5).map(s=>`<tr><td>${new Date(s.date).toLocaleDateString()}</td><td>${s.clientName}</td><td>${s.craneNo}</td><td>${s.totalHours}</td><td>₹${s.amount}</td></tr>`).join('');
  document.getElementById('totalWorksheets').textContent = sheets.length;
}

function renderInvoices(invs){
  const hist = document.getElementById('invoicesHistory'); const recentInv = document.getElementById('recentInvoices');
  hist.innerHTML = invs.map(i=>`<div class=\"border p-2 mb-2\"><div class=\"d-flex justify-content-between\"><strong>${i.invoiceNumber}</strong><span>${i.status}</span></div><div>${i.clientName}</div><div>₹${i.totalAmount}</div><div class=\"mt-2\"><button class=\"btn btn-sm btn-outline-primary\" onclick=\"viewInvoice('${i.id}')\">View</button> <button class=\"btn btn-sm btn-outline-success\" onclick=\"markPaid('${i.id}')\">Mark Paid</button> <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteInvoice('${i.id}')\">Delete</button></div></div>`).join('')||'<div>No invoices</div>';
  recentInv.innerHTML = invs.slice(0,5).map(i=>`<div class=\"mb-2\"><strong>${i.invoiceNumber}</strong><div>${i.clientName}</div><div>₹${i.totalAmount}</div></div>`).join('');
  document.getElementById('totalInvoices').textContent = invs.length;
  const revenue = invs.reduce((s,i)=>s + (i.totalAmount||0),0); document.getElementById('totalRevenue').textContent = '₹'+revenue;
}

function renderUsers(us){
  const tbody = document.getElementById('usersTable'); tbody.innerHTML = us.map(u=>`<tr><td>${u.email||''}</td><td>${u.name||''}</td><td>${u.role||''}</td><td><button class=\"btn btn-sm btn-danger\" onclick=\"deleteUser('${u.id}')\">Delete</button></td></tr>`).join('')||'<tr><td colspan="4">No users</td></tr>';
}
function renderCranes(cs){ document.getElementById('cranesTable').innerHTML = cs.map(c=>`<tr><td>${c.craneNo}</td><td>${c.assignedTo||''}</td><td><button class=\"btn btn-sm btn-danger\" onclick=\"deleteCrane('${c.id}')\">Del</button></td></tr>`).join('')||'<tr><td colspan="3">No cranes</td></tr>'; }

// ---------------- CRUD: Clients ----------------
document.getElementById('saveClientBtn').addEventListener('click', async ()=>{
  const data = { name:document.getElementById('c_name').value, mobile:document.getElementById('c_mobile').value, gst:document.getElementById('c_gst').value, state:document.getElementById('c_state').value, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
  try{ await db.collection('clients').add(data); bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide(); }catch(e){alert(e.message);} });
window.editClient = async (id)=>{
  const doc = await db.collection('clients').doc(id).get(); if(!doc.exists) return; const d = doc.data(); document.getElementById('c_name').value=d.name; document.getElementById('c_mobile').value=d.mobile; document.getElementById('c_gst').value=d.gst; document.getElementById('c_state').value=d.state; document.getElementById('clientModal').querySelector('.modal-title').textContent='Edit Client'; bootstrap.Modal.getInstance(document.getElementById('clientModal'))?.show();
  // Save will create new - for simplicity user can delete then re-add. (Could be extended to edit.)
}
window.deleteClient = async (id)=>{ if(confirm('Delete client?')) { await db.collection('clients').doc(id).delete(); } }

// ---------------- CRUD: Worksheets ----------------
function calcHours(inT,outT,lunchM){ if(!inT||!outT) return 0; const inD=new Date('2000-01-01T'+inT); const outD=new Date('2000-01-01T'+outT); let hrs=(outD-inD)/(1000*60*60); hrs -= (lunchM||0)/60; return Math.max(0, +hrs.toFixed(2)); }
['ws_in','ws_out','ws_lunch','ws_rate'].forEach(id=>document.getElementById(id).addEventListener('change', ()=>{
  const h = calcHours(document.getElementById('ws_in').value, document.getElementById('ws_out').value, parseInt(document.getElementById('ws_lunch').value)||0);
  document.getElementById('ws_total').value = h; const amt = h * (parseFloat(document.getElementById('ws_rate').value)||0); document.getElementById('ws_amount').value = amt.toFixed(2);
}));

document.getElementById('saveWorksheetBtn').addEventListener('click', async ()=>{
  const data = { clientId: document.getElementById('ws_client').value, clientName: document.getElementById('ws_client').options[document.getElementById('ws_client').selectedIndex].text, craneNo: document.getElementById('ws_crane').value, date: document.getElementById('ws_date').value, inTime: document.getElementById('ws_in').value, outTime: document.getElementById('ws_out').value, lunchMinutes: parseInt(document.getElementById('ws_lunch').value)||0, totalHours: parseFloat(document.getElementById('ws_total').value)||0, workDetails: document.getElementById('ws_details').value, ratePerHour: parseFloat(document.getElementById('ws_rate').value)||0, amount: parseFloat(document.getElementById('ws_amount').value)||0, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
  try{ await db.collection('worksheets').add(data); bootstrap.Modal.getInstance(document.getElementById('worksheetModal')).hide(); }catch(e){ alert(e.message); }
});
window.deleteWorksheet = async id=>{ if(confirm('Delete worksheet?')) await db.collection('worksheets').doc(id).delete(); }

// ---------------- CRUD: Invoices ----------------
function resetInvoiceForm(){ document.getElementById('invoiceItems').innerHTML=''; document.getElementById('invSubtotal').textContent='₹0'; document.getElementById('invGST').textContent='₹0'; document.getElementById('invTotal').textContent='₹0'; }

// import client worksheets into invoice items
document.getElementById('importClientWorksheets').addEventListener('click', async ()=>{
  const clientId = document.getElementById('invoiceClient').value; if(!clientId){ alert('Select client'); return; }
  const snap = await db.collection('worksheets').where('clientId','==',clientId).get(); const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()}));
  // render
  const tbody = document.getElementById('invoiceItems'); tbody.innerHTML = items.map(it=>`<tr data-id="${it.id}"><td><input type=checkbox class=\"inv-select\" checked></td><td>${it.date}</td><td>${it.totalHours}</td><td><input class=\"form-control inv-rate\" value=${it.ratePerHour}></td><td class=\"inv-amount\">₹${(it.amount||0).toFixed(2)}</td><td><button class=\"btn btn-sm btn-danger\" onclick=\"removeInvItem(this)\">Remove</button></td></tr>`).join(''); recalcInvoice();
});
function removeInvItem(btn){ btn.closest('tr').remove(); recalcInvoice(); }
function recalcInvoice(){ const rows = Array.from(document.querySelectorAll('#invoiceItems tr')); let subtotal=0; rows.forEach(r=>{ const hrs = parseFloat(r.children[2].textContent)||0; const rate = parseFloat(r.querySelector('.inv-rate')?.value)||0; const amt = hrs*rate; r.querySelector('.inv-amount').textContent = '₹'+amt.toFixed(2); subtotal += amt; }); const gst = subtotal*0.18; const total = subtotal+gst; document.getElementById('invSubtotal').textContent='₹'+subtotal.toFixed(2); document.getElementById('invGST').textContent='₹'+gst.toFixed(2); document.getElementById('invTotal').textContent='₹'+total.toFixed(2); }

// when rate edited
document.addEventListener('input', (e)=>{ if(e.target.classList && e.target.classList.contains('inv-rate')) recalcInvoice(); });

// Generate invoice
document.getElementById('invoiceForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const clientId = document.getElementById('invoiceClient').value; if(!clientId) return alert('Select client'); const rows = Array.from(document.querySelectorAll('#invoiceItems tr')); if(rows.length===0) return alert('Add items'); const items = rows.map(r=>({ worksheetId: r.dataset.id, date: r.children[1].textContent, hours: parseFloat(r.children[2].textContent)||0, rate: parseFloat(r.querySelector('.inv-rate').value)||0, amount: parseFloat(r.querySelector('.inv-amount').textContent.replace('₹',''))||0 })); const subtotal = items.reduce((s,i)=>s+i.amount,0); const gst = +(subtotal*0.18).toFixed(2); const total = +(subtotal+gst).toFixed(2); const invoiceNumber = 'INV-'+Date.now(); const clientName = document.getElementById('invoiceClient').options[document.getElementById('invoiceClient').selectedIndex].text;
  const payload = { clientId, clientName, items, subTotal: subtotal, gst, totalAmount: total, status:'pending', invoiceNumber, date: new Date().toISOString(), createdBy: currentUser.uid };
  try{ const docRef = await db.collection('invoices').add(payload); alert('Invoice created'); resetInvoiceForm(); }catch(err){ alert(err.message); }
});

window.viewInvoice = async (id)=>{ const d = await db.collection('invoices').doc(id).get(); if(!d.exists) return alert('not found'); const inv=d.data(); alert(`Invoice ${inv.invoiceNumber}\nClient: ${inv.clientName}\nTotal: ₹${inv.totalAmount}`); }
window.deleteInvoice = async id=>{ if(confirm('Delete invoice?')) await db.collection('invoices').doc(id).delete(); }
window.markPaid = async id=>{ await db.collection('invoices').doc(id).update({ status:'paid', paidAt: firebase.firestore.FieldValue.serverTimestamp() }); }

// ---------------- Admin: create auth user flow ----------------
// Note: creating a Firebase Auth user with createUserWithEmailAndPassword will sign in as that user.
// To preserve admin session, we ask admin to input their password to reauthenticate after creation.

document.getElementById('saveUserBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('u_email').value; const name = document.getElementById('u_name').value; const role = document.getElementById('u_role').value; const pass = document.getElementById('u_pass').value; const adminPass = document.getElementById('admin_reauth_pass').value;
  if(!email||!pass) return alert('Provide email and temp password');
  if(!confirm('Creating an auth account will temporarily sign you out. You will be asked to re-enter your admin password to continue.')) return;
  const adminEmail = auth.currentUser.email;
  try{
    // create auth user
    await auth.createUserWithEmailAndPassword(email, pass);
    const newUser = auth.currentUser; // now signed in as new user
    // create user doc
    await db.collection('users').doc(newUser.uid).set({ name, email, role, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    // sign out the created user
    await auth.signOut();
    // sign back in as admin using provided admin password
    await auth.signInWithEmailAndPassword(adminEmail, adminPass);
    alert('User created successfully and admin session restored.');
    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
  }catch(err){ alert('Error: '+err.message); try{ await auth.signOut(); auth.signInWithEmailAndPassword(adminEmail, adminPass); }catch(e){ console.warn('Restore failed',e); showAuth(); } }
});

// ---------------- Cranes ----------------
document.getElementById('saveCraneBtn').addEventListener('click', async ()=>{ const craneNo=document.getElementById('crane_no').value; const assigned=document.getElementById('crane_user_email').value || null; if(!craneNo) return alert('Enter crane no'); await db.collection('cranes').add({ craneNo, assignedTo:assigned, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); bootstrap.Modal.getInstance(document.getElementById('craneModal')).hide(); });
window.deleteCrane = async id=>{ if(confirm('Delete crane?')) await db.collection('cranes').doc(id).delete(); }

// ---------------- Users management ----------------
window.deleteUser = async id=>{ if(confirm('Delete user?')) await db.collection('users').doc(id).delete(); }

// ---------------- Initial helper: create default admin if none ----------------
(async function ensureAdminExists(){ const snap = await db.collection('users').limit(1).get(); if(snap.empty){ console.log('No users found - creating a public admin signup is recommended.'); } })();

// End of script
</script>
</body>
</html>
